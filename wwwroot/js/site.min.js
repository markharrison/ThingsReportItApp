function readCookie(e){for(var t=e+"=",i=document.cookie.split(";"),o=0;o<i.length;o++){for(var a=i[o];" "===a.charAt(0);)a=a.substring(1,a.length);if(0===a.indexOf(t))return a.substring(t.length,a.length)}return null}var video=document.getElementById("idVideo"),canvas=document.getElementById("idCanvas"),context=canvas.getContext("2d"),bCameraFirstTime=!0,currLong=1/0,currLat=1/0;function doResize(){var e=1,t=readCookie("CameraScreenSize"),t=(null!=t&&(e=Number(t)/100),Math.floor($("#idCameraWrapper").width())),e=Math.floor($("#idCameraWrapper").width()*e);$("#idVideo").width(e),$("#idCanvas").width(e),$("#idInfo").width(t)}function stateInit(){$("#idButOpenCamera").show(),$("#idButTakePhoto").hide(),$("#idButReportIt").hide(),$("#idVideo").hide(),$("#idCanvas").hide(),$("#idInfo").hide(),$("#idRspMsg").hide()}function stateCapturing(){$("#idButOpenCamera").hide(),$("#idButTakePhoto").show(),$("#idButReportIt").hide(),$("#idVideo").show(),$("#idCanvas").hide(),$("#idInfo").hide(),$("#idRspMsg").hide()}function stateImageCaptured(){$("#idButOpenCamera").show(),$("#idButTakePhoto").hide(),$("#idButReportIt").show(),$("#idVideo").hide(),$("#idCanvas").show(),$("#idInfo").show()}function updateRspMsg(e,t){$("#idRspMsg").html(e),$("#idRspMsg").css("color",t),$("#idRspMsg").show()}function doResponse(e){200==e.status?updateRspMsg("Item reported successfully","green"):updateRspMsg("Error: "+e.responseText,"red")}function doReportIt(){var e=.75,t=readCookie("JPGQuality"),i=(null!=t&&(e=Number(t)),0),t=(null!=(t=readCookie("Thingid"))&&(i=Number(t)),canvas.toDataURL("image/jpeg",e));currLong===1/0?updateRspMsg("Geo location updating - please wait / retry","red"):""==$("#idName").val()?(updateRspMsg("'Name' field is mandatory","red"),$("#idName").focus()):(updateRspMsg("Processing - please wait","green"),$.ajax({type:"POST",url:"/ReportIt",data:JSON.stringify({Thingid:parseInt(i),Image:t,Name:$("#idName").val(),Text:$("#idText").val(),Latitude:currLat,Longitude:currLong}),dataType:"json",headers:{Accept:"application/json","Content-Type":"application/json; charset=utf-8","XSRF-TOKEN":$('input:hidden[name="__RequestVerificationToken"]').val()},complete:function(e){doResponse(e)}}))}function doTakePhoto(){video.pause(),canvas.width=video.clientWidth,canvas.height=video.clientHeight,context.drawImage(video,0,0,video.clientWidth,video.clientHeight),getGeoLocation(),stateImageCaptured()}function doCameraFirstTime(){var e="default",t=readCookie("CameraSelection"),i={video:!0,audio:!1};if("default"!=(e=null!=t?t:e)&&(i.video={facingMode:e}),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return alert("Camera not supported"),stateInit(),!1;navigator.mediaDevices.getUserMedia(i).then(function(e){return video.srcObject=e,video.play(),stateCapturing(),getGeoLocation(),!(bCameraFirstTime=!1)}).catch(function(e){return alert("Camera failure: "+e.name),stateInit(),!1})}function doOpenCamera(){(bCameraFirstTime?doCameraFirstTime:(video.play(),stateCapturing))()}function setGeoLocation(e){currLat=Number(e.coords.latitude.toFixed(6)),currLong=Number(e.coords.longitude.toFixed(6)),$("#idGeoLocation").html(currLat+", "+currLong)}function getGeoLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(setGeoLocation):alert("Geolocation is not supported by this browser")}function doIndexReady(){$("#idButTakePhoto").click(function(){doTakePhoto()}),$("#idButReportIt").click(function(){doReportIt()}),$("#idButOpenCamera").click(function(){doOpenCamera()}),$(window).resize(function(){doResize()}),doResize(),stateInit(),getGeoLocation()}